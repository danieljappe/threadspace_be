generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                                  String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  username                            String         @unique @db.VarChar(30)
  email                               String         @unique @db.VarChar(255)
  passwordHash                        String         @map("password_hash") @db.VarChar(255)
  bio                                 String?
  avatarUrl                           String?        @map("avatar_url") @db.VarChar(500)
  reputation                          Int?           @default(0)
  isVerified                          Boolean?       @default(false) @map("is_verified")
  isAdmin                             Boolean?       @default(false) @map("is_admin")
  createdAt                           DateTime?      @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt                           DateTime?      @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  lastLogin                           DateTime?      @map("last_login") @db.Timestamp(6)
  isActive                            Boolean?       @default(true) @map("is_active")
  audit_logs                          audit_logs[]
  bookmarks                           Bookmark[]
  comments                            Comment[]
  follows_follows_follower_idTousers  Follow[]       @relation("follows_follower_idTousers")
  follows_follows_following_idTousers Follow[]       @relation("follows_following_idTousers")
  notifications                       Notification[]
  posts                               Post[]
  sessions                            Session[]
  user_topics                         UserTopic[]
  votes                               Vote[]

  @@map("users")
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model Post {
  id          String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  authorId    String?     @map("author_id") @db.Uuid
  title       String      @db.VarChar(300)
  content     String
  threadType  ThreadType? @default(DISCUSSION) @map("thread_type")
  views       Int?        @default(0)
  isPinned    Boolean?    @default(false) @map("is_pinned")
  isLocked    Boolean?    @default(false) @map("is_locked")
  createdAt   DateTime?   @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime?   @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  deletedAt   DateTime?   @map("deleted_at") @db.Timestamp(6)
  bookmarks   Bookmark[]
  comments    Comment[]
  post_topics PostTopic[]
  users       User?       @relation(fields: [authorId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([authorId], map: "idx_posts_author")
  @@index([createdAt(sort: Desc)], map: "idx_posts_created")
  @@index([threadType], map: "idx_posts_thread_type")
  @@map("posts")
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model Comment {
  id             String                @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  postId         String?               @map("post_id") @db.Uuid
  parentId       String?               @map("parent_id") @db.Uuid
  authorId       String?               @map("author_id") @db.Uuid
  content        String
  depth          Int?                  @default(0)
  path           Unsupported("ltree")?
  isEdited       Boolean?              @default(false) @map("is_edited")
  createdAt      DateTime?             @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt      DateTime?             @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  deletedAt      DateTime?             @map("deleted_at") @db.Timestamp(6)
  users          User?                 @relation(fields: [authorId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  comments       Comment?              @relation("commentsTocomments", fields: [parentId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  other_comments Comment[]             @relation("commentsTocomments")
  posts          Post?                 @relation(fields: [postId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([authorId], map: "idx_comments_author")
  @@index([path], map: "idx_comments_path", type: Gist)
  @@index([postId], map: "idx_comments_post")
  @@map("comments")
}

model Topic {
  id              String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name            String      @unique @db.VarChar(100)
  slug            String      @unique @db.VarChar(100)
  description     String?
  color           String?     @db.VarChar(7)
  subscriberCount Int?        @default(0) @map("subscriber_count")
  createdAt       DateTime?   @default(now()) @map("created_at") @db.Timestamp(6)
  post_topics     PostTopic[]
  user_topics     UserTopic[]

  @@map("topics")
}

model PostTopic {
  postId  String @map("post_id") @db.Uuid
  topicId String @map("topic_id") @db.Uuid
  posts   Post   @relation(fields: [postId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  topics  Topic  @relation(fields: [topicId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([postId, topicId])
  @@map("post_topics")
}

model UserTopic {
  userId       String    @map("user_id") @db.Uuid
  topicId      String    @map("topic_id") @db.Uuid
  subscribedAt DateTime? @default(now()) @map("subscribed_at") @db.Timestamp(6)
  topics       Topic     @relation(fields: [topicId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users        User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([userId, topicId])
  @@map("user_topics")
}

model Follow {
  followerId                        String    @map("follower_id") @db.Uuid
  followingId                       String    @map("following_id") @db.Uuid
  createdAt                         DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  users_follows_follower_idTousers  User      @relation("follows_follower_idTousers", fields: [followerId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users_follows_following_idTousers User      @relation("follows_following_idTousers", fields: [followingId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([followerId, followingId])
  @@map("follows")
}

model Vote {
  id          String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId      String      @map("user_id") @db.Uuid
  votableId   String      @map("votable_id") @db.Uuid
  votableType VotableType @map("votable_type")
  voteType    VoteType    @map("vote_type")
  createdAt   DateTime?   @default(now()) @map("created_at") @db.Timestamp(6)
  users       User        @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, votableId, votableType])
  @@index([votableId, votableType], map: "idx_votes_votable")
  @@map("votes")
}

model Bookmark {
  userId    String    @map("user_id") @db.Uuid
  postId    String    @map("post_id") @db.Uuid
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  posts     Post      @relation(fields: [postId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users     User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([userId, postId])
  @@map("bookmarks")
}

model Notification {
  id        String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String?          @map("user_id") @db.Uuid
  type      NotificationType
  data      Json
  isRead    Boolean?         @default(false) @map("is_read")
  createdAt DateTime?        @default(now()) @map("created_at") @db.Timestamp(6)
  users     User?            @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([userId, isRead], map: "idx_notifications_user")
  @@map("notifications")
}

model Session {
  id               String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId           String?   @map("user_id") @db.Uuid
  tokenHash        String    @unique @map("token_hash") @db.VarChar(255)
  refreshTokenHash String?   @unique @map("refresh_token_hash") @db.VarChar(255)
  expiresAt        DateTime  @map("expires_at") @db.Timestamp(6)
  createdAt        DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  lastActivity     DateTime? @default(now()) @map("last_activity") @db.Timestamp(6)
  users            User?     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tokenHash], map: "idx_sessions_token")
  @@map("sessions")
}

model audit_logs {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id    String?   @db.Uuid
  action     String    @db.VarChar(100)
  table_name String?   @db.VarChar(100)
  record_id  String?   @db.Uuid
  old_data   Json?
  new_data   Json?
  ip_address String?   @db.Inet
  user_agent String?
  created_at DateTime? @default(now()) @db.Timestamp(6)
  users      User?     @relation(fields: [user_id], references: [id], onUpdate: NoAction)

  @@index([user_id], map: "idx_audit_logs_user")
}

enum ThreadType {
  DISCUSSION
  QUESTION
  ANNOUNCEMENT
  POLL

  @@map("thread_type")
}

enum VoteType {
  UPVOTE
  DOWNVOTE

  @@map("vote_type")
}

enum VotableType {
  post
  comment

  @@map("votable_type")
}

enum NotificationType {
  COMMENT
  REPLY
  FOLLOW
  MENTION
  VOTE

  @@map("notification_type")
}
